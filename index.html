<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria Santa Sensação - O Sabor Original</title>
    <meta name="description" content="Experimente a melhor pizza de Santa Leopoldina, feita com ingredientes frescos em forno a lenha. Peça agora!">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        :root {
            --color-primary: #8B0000; --color-primary-dark: #6a0000; --color-secondary: #D4AF37; --color-background: #FDF8F0; --color-surface: #FFFFFF; --color-text: #333333; --color-text-light: #666666; --color-white: #FFFFFF; --color-border: #EAE0D5; --color-success: #28a745; --color-error: #dc3545;
            --font-display: 'Playfair Display', serif; --font-body: 'Montserrat', sans-serif;
            --radius-md: 8px; --radius-lg: 16px; --spacing-sm: 8px; --spacing-md: 16px; --spacing-lg: 32px; --spacing-xl: 64px;
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1); --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
            --transition-fast: 200ms ease-in-out; --transition-normal: 400ms ease-in-out;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-body); background-color: var(--color-background); color: var(--color-text); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 var(--spacing-md); }
        .hidden { display: none !important; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: 12px 24px; border-radius: var(--radius-md); font-weight: 600; text-decoration: none; cursor: pointer; transition: all var(--transition-fast); border: 2px solid transparent; font-size: 1rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn .fa-spin { margin-right: 8px; }
        .btn--primary { background-color: var(--color-primary); color: var(--color-white); }
        .btn--primary:hover:not(:disabled) { background-color: var(--color-primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn--secondary { background-color: transparent; color: var(--color-primary); border-color: var(--color-primary); }
        .btn--secondary:hover:not(:disabled) { background-color: var(--color-primary); color: var(--color-white); }
        #app { transition: opacity var(--transition-normal); }
        .header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; padding: var(--spacing-md) 0; transition: all var(--transition-fast); }
        .header.scrolled { background-color: rgba(255, 255, 255, 0.95); box-shadow: var(--shadow-md); backdrop-filter: blur(10px); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: var(--font-display); font-size: 1.8rem; color: var(--color-primary); display: flex; align-items: center; gap: var(--spacing-sm); text-decoration: none; }
        .nav-links { display: flex; gap: var(--spacing-lg); }
        .nav-link { text-decoration: none; color: var(--color-text); font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: var(--spacing-md); }
        .cart-button { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: var(--color-text); position: relative; }
        .cart-count { position: absolute; top: -5px; right: -10px; background-color: var(--color-primary); color: var(--color-white); border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .section { padding: var(--spacing-xl) 0; }
        .section-header { text-align: center; margin-bottom: var(--spacing-lg); }
        .section-title { font-family: var(--font-display); font-size: 2.8rem; color: var(--color-primary); margin-bottom: var(--spacing-sm); }
        .section-subtitle { font-size: 1.1rem; color: var(--color-text-light); max-width: 600px; margin: 0 auto; }
        #inicio { min-height: 100vh; display: flex; align-items: center; background: url('https://images.unsplash.com/photo-1564936662393-20a225139044?auto=format&fit=crop&w=1500&q=80') no-repeat center center/cover; position: relative; }
        #inicio::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); }
        .hero-content { position: relative; z-index: 2; text-align: center; color: var(--color-white); }
        .hero-title { font-family: var(--font-display); font-size: clamp(3rem, 6vw, 5rem); line-height: 1.1; margin-bottom: var(--spacing-md); }
        .hero-subtitle { font-size: 1.5rem; margin-bottom: var(--spacing-lg); font-weight: 400; }
        .hero-title span { color: var(--color-secondary); }
        #cardapio { background-color: var(--color-surface); }
        .menu-header { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
        .menu-categories { display: flex; justify-content: center; gap: var(--spacing-md); flex-wrap: wrap; }
        .category-tab { background-color: transparent; border: 2px solid var(--color-border); padding: 10px 20px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; transition: all var(--transition-fast); }
        .category-tab:hover, .category-tab.active { background-color: var(--color-primary); color: var(--color-white); border-color: var(--color-primary); }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: var(--spacing-lg); }
        .menu-card { background-color: var(--color-surface); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-md); transition: all var(--transition-fast); display: flex; flex-direction: column; }
        .menu-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .menu-card-image { height: 220px; width: 100%; object-fit: cover; }
        .menu-card-content { padding: var(--spacing-md); flex-grow: 1; display: flex; flex-direction: column; }
        .menu-card-title { font-family: var(--font-display); font-size: 1.5rem; color: var(--color-primary); }
        .menu-card-description { color: var(--color-text-light); margin: var(--spacing-sm) 0 var(--spacing-md); flex-grow: 1; }
        .size-options { display: flex; gap: var(--spacing-sm); }
        .size-btn { flex: 1; background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--spacing-sm); cursor: pointer; text-align: center; }
        .size-btn:hover { border-color: var(--color-primary); }
        .size-name { display: block; font-weight: 600; }
        .size-price { display: block; font-size: 0.9rem; color: var(--color-primary); }
        .about-content, .contact-content { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-xl); align-items: center; }
        .about-image { width: 100%; height: 400px; object-fit: cover; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); }
        .footer { background-color: #2b2b2b; color: var(--color-white); padding: var(--spacing-lg) 0; text-align: center; }
        .cart-sidebar { position: fixed; top: 0; right: 0; width: 100%; max-width: 400px; height: 100%; background-color: var(--color-surface); box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 2000; transform: translateX(100%); transition: transform var(--transition-normal); display: flex; flex-direction: column; }
        .cart-sidebar.open { transform: translateX(0); }
        .cart-header { padding: var(--spacing-md); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); }
        .cart-header h3 { font-family: var(--font-display); }
        .cart-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .cart-body { flex-grow: 1; padding: var(--spacing-md); overflow-y: auto; }
        .cart-item-info { width: 100%; }
        .cart-item-title { font-weight: 600;}
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); }
        .cart-item-controls { display: flex; align-items: center; gap: var(--spacing-sm); margin-top: 4px; }
        .quantity-btn { background: var(--color-border); border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .cart-item-remove { background: none; border: none; color: var(--color-error); cursor: pointer; margin-left: auto; }
        .cart-footer { padding: var(--spacing-md); border-top: 1px solid var(--color-border); }
        .cart-total { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; margin-bottom: var(--spacing-md); }
        .admin-page { padding-top: 120px; padding-bottom: var(--spacing-xl); }
        .admin-container { display: flex; gap: var(--spacing-lg); align-items: flex-start; }
        .admin-nav { display: flex; flex-direction: column; gap: var(--spacing-sm); width: 200px; flex-shrink: 0; }
        .admin-nav-btn { padding: 12px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; background: none; border: none; text-align: left; width: 100%; font-size: 1rem; }
        .admin-nav-btn.active, .admin-nav-btn:hover { background-color: var(--color-border); }
        .admin-content { flex-grow: 1; background-color: var(--color-surface); padding: var(--spacing-lg); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: var(--spacing-lg); }
        .admin-table th, .admin-table td { text-align: left; padding: var(--spacing-md); border-bottom: 1px solid var(--color-border); }
        .admin-actions button { background: none; border: none; cursor: pointer; margin-right: var(--spacing-md); font-size: 1.1rem; }
        .btn-edit { color: var(--color-secondary); }
        .btn-delete { color: var(--color-error); }
        .form-group { margin-bottom: var(--spacing-md); }
        .form-group label { font-weight: 600; display: block; margin-bottom: var(--spacing-sm); }
        .form-control { padding: 12px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem; width: 100%; }
        .form-control:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(139,0,0,0.2); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); z-index: 1999; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all var(--transition-fast); }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: var(--color-surface); padding: var(--spacing-lg); border-radius: var(--radius-lg); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform var(--transition-fast); }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); }
        .modal-title { font-family: var(--font-display); font-size: 1.8rem; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-light); }
        .modal-footer { margin-top: var(--spacing-lg); display: flex; justify-content: flex-end; gap: var(--spacing-md); }
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .about-content, .contact-content { grid-template-columns: 1fr; }
            .admin-container { flex-direction: column; }
            .admin-nav { width: 100%; flex-direction: row; overflow-x: auto; }
        }
    </style>
</head>
<body>
    <div id="app"><div style="display: flex; justify-content: center; align-items: center; height: 100vh;"><i class="fas fa-spinner fa-spin fa-3x" style="color: var(--color-primary);"></i></div></div>
    <div id="modals-container"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, onSnapshot, orderBy, query, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTMHlUCGOpU7VRIdbP2VADzUF9n1lI88A",
            authDomain: "site-pizza-a2930.firebaseapp.com",
            projectId: "site-pizza-a2930",
            storageBucket: "site-pizza-a2930.appspot.com",
            messagingSenderId: "914255031241",
            appId: "1:914255031241:web:84ae273b22cb7d04499618"
        };

        // --- CORE APP STATE ---
        const state = {
            firebaseApp: initializeApp(firebaseConfig),
            auth: null,
            db: null,
            user: undefined, 
            isAdmin: false,
            menu: { categories: [], items: [] },
            cart: [],
            activeCategory: null,
            listeners: {},
            activeAdminTab: 'cardapio',
        };
        state.auth = getAuth(state.firebaseApp);
        state.db = getFirestore(state.firebaseApp);
        
        // --- DOM ELEMENTS ---
        const getAppRoot = () => document.getElementById('app');
        const modalsContainer = document.getElementById('modals-container');

        // --- UTILS & HELPERS ---
        const formatPrice = (price) => Number(price).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const saveCartToStorage = () => localStorage.setItem('pizzariaCart', JSON.stringify(state.cart));
        const loadCartFromStorage = () => JSON.parse(localStorage.getItem('pizzariaCart') || '[]');

        // --- RENDER FUNCTIONS ---
        const render = () => {
            const hash = window.location.hash || '#';
            if (hash.startsWith('#admin')) {
                renderAdminPage();
            } else {
                renderHomePage();
            }
        };

        const renderHomePage = () => {
            getAppRoot().innerHTML = `
                <header class="header" id="header"><div class="container header-content"><a href="#" class="logo"><i class="fas fa-pizza-slice"></i> Santa Sensação</a><nav class="nav-links"><a href="#inicio" class="nav-link active">Início</a><a href="#cardapio" class="nav-link">Cardápio</a><a href="#sobre" class="nav-link">Sobre</a></nav><div class="header-actions"><button class="cart-button" id="open-cart-btn"><i class="fas fa-shopping-cart"></i><span class="cart-count hidden">0</span></button><a href="#admin" class="btn btn--secondary">Admin</a></div></div></header>
                <main>
                    <section id="inicio"><div class="container hero-content"><h1 class="hero-title">O Sabor Original de <span>Santa Leopoldina</span></h1><p class="hero-subtitle">Massa artesanal, ingredientes frescos e o calor do forno a lenha.</p><a href="#cardapio" class="btn btn--primary">Ver Cardápio</a></div></section>
                    <section id="cardapio" class="section"><div class="container"><div class="section-header"><h2 class="section-title">Nosso Cardápio</h2><p class="section-subtitle">Pizzas preparadas com amor e tradição.</p></div><div class="menu-header"><div class="menu-categories" id="menu-categories"></div></div><div class="menu-grid" id="menu-grid"></div></div></section>
                    <section id="sobre" class="section"><div class="container about-content"><div><div class="section-header" style="text-align: left;"><h2 class="section-title">Nossa História</h2></div><p>Na Pizzaria Santa Sensação, cada pizza é uma obra de arte. Usamos a receita de massa que nossa família aperfeiçoa há décadas, ingredientes selecionados e um autêntico forno a lenha.</p></div><img src="https://images.unsplash.com/photo-1590947132387-155cc02f3212?auto=format&fit=crop&w=800&q=80" alt="Forno a lenha da pizzaria" class="about-image"></div></section>
                </main>
                <footer class="footer"><div class="container"><a href="#" class="logo"><i class="fas fa-pizza-slice"></i> Santa Sensação</a><p>&copy; ${new Date().getFullYear()} Pizzaria Santa Sensação. Todos os direitos reservados.</p></div></footer>
                <div class="cart-overlay hidden" id="cart-overlay"></div><aside class="cart-sidebar" id="cart-sidebar"><div class="cart-header"><h3><i class="fas fa-shopping-cart"></i> Seu Pedido</h3><button class="cart-close-btn" id="cart-close-btn"><i class="fas fa-times"></i></button></div><div class="cart-body" id="cart-body"></div><div class="cart-footer hidden" id="cart-footer"><div class="cart-total"><span>Total:</span><span id="cart-total-price">R$ 0,00</span></div><button class="btn btn--primary" id="finish-order-btn" style="width: 100%;">Finalizar Pedido</button></div></aside>
            `;
            updateMenuUI();
            updateCartUI();
            attachHomeEventListeners();
        };
        
        const renderAdminPage = () => {
            const appRoot = getAppRoot();
            if (state.user === undefined) {
                 appRoot.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100vh;"><i class="fas fa-spinner fa-spin fa-3x" style="color: var(--color-primary);"></i></div>`;
                 return;
            }
            if (state.user === null) {
                appRoot.innerHTML = renderAdminLogin();
                attachAdminLoginListeners();
            } else {
                appRoot.innerHTML = renderAdminPanel();
                renderAdminTabContent();
                attachAdminPanelListeners();
            }
        };

        const renderAdminLogin = () => `<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh;"><div class="modal-content" style="max-width: 400px;"><div class="section-header"><h2 class="section-title">Acesso Restrito</h2><a href="#" style="position: absolute; top: 16px; right: 16px; font-size: 1.5rem; color: var(--color-text-light); text-decoration:none;">&times;</a></div><form id="admin-login-form"><div class="form-group"><label for="email">Email</label><input type="email" id="email" class="form-control" required></div><div class="form-group"><label for="password">Senha</label><input type="password" id="password" class="form-control" required></div><p id="login-error" class="hidden" style="color: var(--color-error);"></p><button type="submit" class="btn btn--primary" style="width: 100%;">Entrar</button></form></div></div>`;
        
        const renderAdminPanel = () => `<div class="container admin-page"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;"><h2 class="section-title">Painel Administrativo</h2><div><a href="#" class="btn btn--primary">Voltar ao Site</a><button id="logout-btn" class="btn btn--secondary">Sair</button></div></div>${!state.isAdmin ? '<p style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 8px; border: 1px solid #ffeeba;"><b>Atenção:</b> Você não tem permissão de administrador.</p>' : ''}<div class="admin-container"><nav class="admin-nav" id="admin-nav"><button class="admin-nav-btn ${state.activeAdminTab === 'cardapio' ? 'active' : ''}" data-tab="cardapio"><i class="fas fa-utensils"></i> Cardápio</button><button class="admin-nav-btn ${state.activeAdminTab === 'categorias' ? 'active' : ''}" data-tab="categorias"><i class="fas fa-tags"></i> Categorias</button><button class="admin-nav-btn ${state.activeAdminTab === 'seguranca' ? 'active' : ''}" data-tab="seguranca"><i class="fas fa-shield-alt"></i> Segurança</button></nav><div class="admin-content" id="admin-content"></div></div></div>`;
        
        const renderAdminTabContent = () => {
             const container = document.getElementById('admin-content');
             if (!container) return;
             switch(state.activeAdminTab) {
                case 'categorias':
                    container.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><h3>Categorias</h3><button class="btn btn--primary" id="add-category-btn" ${!state.isAdmin ? 'disabled' : ''}><i class="fas fa-plus"></i> Nova</button></div><table class="admin-table"><thead><tr><th>Ordem</th><th>Nome</th><th>Ações</th></tr></thead><tbody id="category-table-body">${renderCategoriesTableRows()}</tbody></table>`;
                    break;
                case 'cardapio':
                     container.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><h3>Itens do Cardápio</h3><button class="btn btn--primary" id="add-item-btn" ${!state.isAdmin ? 'disabled' : ''}><i class="fas fa-plus"></i> Novo</button></div><table class="admin-table"><thead><tr><th>Nome</th><th>Categoria</th><th>Preços</th><th>Ações</th></tr></thead><tbody id="item-table-body">${renderItemsTableRows()}</tbody></table>`;
                    break;
                case 'seguranca':
                    container.innerHTML = `<h3>Alterar Senha</h3><form id="change-password-form"><div class="form-group"><label for="new-password">Nova Senha</label><input type="password" id="new-password" class="form-control" required minlength="6"></div><div class="form-group"><label for="confirm-password">Confirmar Nova Senha</label><input type="password" id="confirm-password" class="form-control" required></div><p id="password-error" class="hidden" style="color: var(--color-error);"></p><p id="password-success" class="hidden" style="color: var(--color-success);"></p><button type="submit" class="btn btn--primary" style="margin-top: 16px;" ${!state.isAdmin ? 'disabled' : ''}>Salvar Alterações</button></form>`;
                    break;
             }
        }

        const renderCategoriesTableRows = () => state.menu.categories.map(cat => `<tr><td>${cat.order}</td><td>${cat.name}</td><td class="admin-actions"><button class="btn-edit" data-id="${cat.id}" ${!state.isAdmin ? 'disabled' : ''}><i class="fas fa-edit"></i></button><button class="btn-delete" data-id="${cat.id}" ${!state.isAdmin ? 'disabled' : ''}><i class="fas fa-trash"></i></button></td></tr>`).join('');
        const renderItemsTableRows = () => state.menu.items.map(item => `<tr><td>${item.name}</td><td>${state.menu.categories.find(c => c.id === item.categoryId)?.name || 'N/A'}</td><td>${Object.keys(item.prices).join(', ')}</td><td class="admin-actions"><button class="btn-edit" data-id="${item.id}" ${!state.isAdmin ? 'disabled' : ''}><i class="fas fa-edit"></i></button><button class="btn-delete" data-id="${item.id}" ${!state.isAdmin ? 'disabled' : ''}><i class="fas fa-trash"></i></button></td></tr>`).join('');

        // --- UI UPDATE FUNCTIONS ---
        const updateMenuUI = () => {
            if (window.location.hash.startsWith('#admin')) return;
            const categoriesContainer = document.getElementById('menu-categories');
            const grid = document.getElementById('menu-grid');
            if (!categoriesContainer || !grid) return;

            categoriesContainer.innerHTML = state.menu.categories.map(cat => `<button class="category-tab ${state.activeCategory === cat.id ? 'active' : ''}" data-category-id="${cat.id}">${cat.name}</button>`).join('');
            
            const itemsToShow = state.menu.items.filter(item => item.categoryId === state.activeCategory);
            grid.innerHTML = itemsToShow.length === 0 
                ? `<p style="text-align:center; padding: 2rem;">Nenhum item encontrado nesta categoria.</p>`
                : itemsToShow.map(item => `
                <div class="menu-card"><img src="${item.imageUrl || 'https://placehold.co/600x400/8B0000/FDF8F0?text=Pizza'}" alt="${item.name}" class="menu-card-image"><div class="menu-card-content"><h3 class="menu-card-title">${item.name}</h3><p class="menu-card-description">${item.description}</p><div class="menu-card-footer"><div class="size-options">${Object.entries(item.prices).map(([size, price]) => `<button class="size-btn" data-item-id="${item.id}" data-size="${size}" data-price="${price}"><span class="size-name">${size}</span><span class="size-price">${formatPrice(price)}</span></button>`).join('')}</div></div></div></div>`).join('');
        };
        
        const updateCartUI = () => {
            const cartBody = document.getElementById('cart-body'), cartFooter = document.getElementById('cart-footer'), cartCount = document.querySelector('.cart-count'), cartTotalPrice = document.getElementById('cart-total-price');
            if (!cartBody || !cartCount) return;

            const totalItems = state.cart.reduce((s, i) => s + i.quantity, 0);
            cartCount.textContent = totalItems;
            cartCount.classList.toggle('hidden', totalItems === 0);
            cartFooter?.classList.toggle('hidden', totalItems === 0);
            
            cartBody.innerHTML = state.cart.length === 0 ? `<p style="text-align: center; color: var(--color-text-light);">Seu carrinho está vazio.</p>` : state.cart.map(item => `<div class="cart-item" data-cart-id="${item.cartId}"><div class="cart-item-info"><p class="cart-item-title">${item.name}</p><p class="cart-item-details">${item.size} - ${formatPrice(item.price)}</p><div class="cart-item-controls"><button class="quantity-btn" data-action="decrease">-</button><span>${item.quantity}</span><button class="quantity-btn" data-action="increase">+</button><button class="cart-item-remove" data-action="remove"><i class="fas fa-trash"></i></button></div></div></div>`).join('');

            const total = state.cart.reduce((s, i) => s + i.price * i.quantity, 0);
            if(cartTotalPrice) cartTotalPrice.textContent = formatPrice(total);
        };

        // --- EVENT HANDLERS & ACTIONS ---
        const handleAuthChange = async (user) => {
            state.user = user;
            state.isAdmin = user ? (await getDoc(doc(state.db, 'admins', user.uid))).exists() : false;
            render();
        };

        const handleRouting = () => {
            Object.values(state.listeners).forEach(unsubscribe => unsubscribe());
            state.listeners = {};
            setupFirestoreListeners();
            render();
        };

        const attachHomeEventListeners = () => {
            const header = document.getElementById('header');
            if(header) {
                const scrollHandler = () => header.classList.toggle('scrolled', window.scrollY > 50);
                window.addEventListener('scroll', scrollHandler);
            }

            getAppRoot().addEventListener('click', e => {
                const categoryTab = e.target.closest('.category-tab');
                if (categoryTab) { state.activeCategory = categoryTab.dataset.categoryId; updateMenuUI(); return; }
                
                const sizeBtn = e.target.closest('.size-btn');
                if (sizeBtn) { const { itemId, size, price } = sizeBtn.dataset; addToCart(itemId, size, parseFloat(price)); return; }
                
                if(e.target.closest('#open-cart-btn')) { toggleCart(true); return; }
                if(e.target.closest('#cart-close-btn') || e.target.closest('#cart-overlay')) { toggleCart(false); return; }

                const cartActionBtn = e.target.closest('[data-action]');
                if(cartActionBtn) { const cartItemEl = e.target.closest('.cart-item'); if(cartItemEl) { handleCartAction(cartItemEl.dataset.cartId, cartActionBtn.dataset.action); } return; }

                if (e.target.closest('#finish-order-btn')) { handleFinishOrder(); }
            });
        };
        
        const attachAdminLoginListeners = () => {
            const form = document.getElementById('admin-login-form');
            if (form) form.addEventListener('submit', async e => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Entrando...`;
                const email = form.email.value, password = form.password.value, errorEl = document.getElementById('login-error');
                try {
                    await signInWithEmailAndPassword(state.auth, email, password);
                } catch (error) {
                    errorEl.textContent = "Email ou senha incorretos.";
                    errorEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerHTML = 'Entrar';
                }
            });
        };

        const attachAdminPanelListeners = () => {
            const app = getAppRoot();
            app.addEventListener('click', e => {
                if(e.target.closest('#logout-btn')) { signOut(state.auth); }
                const navBtn = e.target.closest('.admin-nav-btn');
                if (navBtn) { state.activeAdminTab = navBtn.dataset.tab; renderAdminPage(); }
                
                if (e.target.closest('#add-category-btn')) handleEditCategory();
                if (e.target.closest('#add-item-btn')) handleEditItem();

                const editBtn = e.target.closest('.btn-edit');
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    if (state.activeAdminTab === 'categorias') handleEditCategory(id);
                    if (state.activeAdminTab === 'cardapio') handleEditItem(id);
                }
                const deleteBtn = e.target.closest('.btn-delete');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (state.activeAdminTab === 'categorias') handleDeleteCategory(id);
                    if (state.activeAdminTab === 'cardapio') handleDeleteItem(id);
                }
            });
            const passForm = document.getElementById('change-password-form');
            if (passForm) passForm.addEventListener('submit', handleChangePassword);
        };

        const addToCart = (itemId, size, price) => {
            const itemDetails = state.menu.items.find(i => i.id === itemId);
            if (!itemDetails) return;
            const cartId = `${itemId}-${size}`;
            const existingItem = state.cart.find(item => item.cartId === cartId);
            if (existingItem) { existingItem.quantity++; } 
            else { state.cart.push({ cartId, itemId, name: itemDetails.name, size, price, quantity: 1 }); }
            saveCartToStorage();
            updateCartUI();
            toggleCart(true);
        };

        const handleCartAction = (cartId, action) => {
             const itemIndex = state.cart.findIndex(i => i.cartId === cartId);
             if (itemIndex === -1) return;
             if (action === 'increase') state.cart[itemIndex].quantity++;
             else if (action === 'decrease') { if (--state.cart[itemIndex].quantity <= 0) state.cart.splice(itemIndex, 1); } 
             else if (action === 'remove') { state.cart.splice(itemIndex, 1); }
             saveCartToStorage();
             updateCartUI();
        };

        const toggleCart = (open) => {
            document.getElementById('cart-sidebar')?.classList.toggle('open', open);
            document.getElementById('cart-overlay')?.classList.toggle('hidden', !open);
        };

        const handleFinishOrder = () => {
            if (state.cart.length === 0) {
                 showModal({ title: 'Atenção', body: '<p>Seu carrinho está vazio.</p>', confirmText: 'OK', showCancel: false});
                 return;
            }
            showFormModal({
                title: 'Dados para Entrega',
                body: `<div class="form-group"><label for="customer-name">Nome *</label><input type="text" id="customer-name" name="name" class="form-control" required></div><div class="form-group"><label for="customer-address">Endereço Completo *</label><input type="text" id="customer-address" name="address" class="form-control" required></div>`,
                submitText: `<i class="fab fa-whatsapp"></i> Enviar Pedido`,
                onSubmit: (formData) => {
                    const name = formData.get('name').trim();
                    const address = formData.get('address').trim();
                    if (name && address) {
                        sendWhatsAppMessage(name, address);
                        state.cart = [];
                        saveCartToStorage();
                        updateCartUI();
                    }
                }
            });
        }
        
        const sendWhatsAppMessage = (name, address) => {
            const total = state.cart.reduce((s, i) => s + i.price * i.quantity, 0);
            const itemsList = state.cart.map(i => `- ${i.quantity}x ${i.name} (${i.size})`).join('\n');
            const message = `Olá, Santa Sensação! Gostaria de fazer o seguinte pedido:\n\n*MEU PEDIDO:*\n${itemsList}\n\n*Total: ${formatPrice(total)}*\n\n*NOME:* ${name}\n*ENDEREÇO DE ENTREGA:* ${address}`;
            const whatsappUrl = `https://wa.me/5527996500341?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        };

        const handleChangePassword = async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;
            const newPassword = form['new-password'].value, confirmPassword = form['confirm-password'].value;
            const errorEl = document.getElementById('password-error'), successEl = document.getElementById('password-success');
            errorEl.classList.add('hidden'); successEl.classList.add('hidden');

            if (newPassword !== confirmPassword) {
                errorEl.textContent = 'As senhas não coincidem.';
                errorEl.classList.remove('hidden');
                btn.disabled = false;
                return;
            }
            try {
                await updatePassword(state.user, newPassword);
                successEl.textContent = 'Senha alterada com sucesso!';
                successEl.classList.remove('hidden');
                form.reset();
            } catch (error) {
                errorEl.textContent = 'Erro ao alterar a senha. Faça login novamente se o erro persistir.';
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
            }
        };

        // --- FIRESTORE CRUD ---
        const handleEditCategory = (id = null) => {
            const cat = id ? state.menu.categories.find(c => c.id === id) : { name: '', order: state.menu.categories.length + 1 };
            if(!cat) return;
            showFormModal({
                title: id ? 'Editar Categoria' : 'Nova Categoria',
                body: `<div class="form-group"><label for="name">Nome</label><input type="text" name="name" class="form-control" value="${cat.name}" required></div><div class="form-group"><label for="order">Ordem</label><input type="number" name="order" class="form-control" value="${cat.order}" required></div>`,
                onSubmit: async (formData) => {
                    const data = { name: formData.get('name'), order: Number(formData.get('order')) };
                    if (id) {
                        await updateDoc(doc(state.db, 'menu_categories', id), data);
                    } else {
                        await addDoc(collection(state.db, 'menu_categories'), data);
                    }
                }
            });
        };

        const handleEditItem = (id = null) => {
            const item = id ? state.menu.items.find(i => i.id === id) : { name: '', description: '', categoryId: '', prices: {}, imageUrl: '', displayOrder: state.menu.items.length + 1 };
            if(!item) return;
            const catOptions = state.menu.categories.map(c => `<option value="${c.id}" ${c.id === item.categoryId ? 'selected' : ''}>${c.name}</option>`).join('');
            
            showFormModal({
                title: id ? 'Editar Item' : 'Novo Item',
                body: `<div class="form-group"><label>Nome</label><input type="text" name="name" value="${item.name}" required class="form-control"></div><div class="form-group"><label>Categoria</label><select name="categoryId" required class="form-control"><option value="">Selecione...</option>${catOptions}</select></div><div class="form-group"><label>Descrição</label><textarea name="description" class="form-control" rows="4">${item.description || ''}</textarea></div><div class="form-group"><label>Preços (P, M, G, Único)</label><div style="display:flex; gap:8px;"><input name="priceP" placeholder="P" value="${item.prices.P || ''}" class="form-control"><input name="priceM" placeholder="M" value="${item.prices.M || ''}" class="form-control"><input name="priceG" placeholder="G" value="${item.prices.G || ''}" class="form-control"><input name="priceUnica" placeholder="Único" value="${item.prices['Única'] || ''}" class="form-control"></div></div><div class="form-group"><label>Ordem de Exibição</label><input type="number" name="displayOrder" value="${item.displayOrder || ''}" class="form-control"></div><div class="form-group"><label>URL da Imagem</label><input type="url" name="imageUrl" value="${item.imageUrl || ''}" class="form-control"></div>`,
                onSubmit: async (fd) => {
                    const prices = {};
                    if(fd.get('priceP')) prices.P = Number(fd.get('priceP'));
                    if(fd.get('priceM')) prices.M = Number(fd.get('priceM'));
                    if(fd.get('priceG')) prices.G = Number(fd.get('priceG'));
                    if(fd.get('priceUnica')) prices['Única'] = Number(fd.get('priceUnica'));

                    const data = { name: fd.get('name'), categoryId: fd.get('categoryId'), description: fd.get('description'), prices, displayOrder: Number(fd.get('displayOrder')), imageUrl: fd.get('imageUrl') };
                    if (id) {
                        await updateDoc(doc(state.db, 'menu_items', id), data);
                    } else {
                        await addDoc(collection(state.db, 'menu_items'), data);
                    }
                }
            });
        };
        
        const handleDeleteCategory = (id) => showModal({ title: 'Confirmar Exclusão', body: `<p>Tem certeza que deseja excluir esta categoria?</p>`, confirmText: 'Excluir', onConfirm: () => deleteDoc(doc(state.db, 'menu_categories', id)) });
        const handleDeleteItem = (id) => showModal({ title: 'Confirmar Exclusão', body: `<p>Tem certeza que deseja excluir este item?</p>`, confirmText: 'Excluir', onConfirm: () => deleteDoc(doc(state.db, 'menu_items', id)) });

        // --- FIRESTORE LISTENERS ---
        const setupFirestoreListeners = () => {
            const catQuery = query(collection(state.db, 'menu_categories'), orderBy('order'));
            state.listeners.categories = onSnapshot(catQuery, (snapshot) => {
                state.menu.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!state.activeCategory && state.menu.categories.length > 0) { state.activeCategory = state.menu.categories[0].id; }
                window.location.hash.startsWith('#admin') ? renderAdminPage() : updateMenuUI();
            }, (err) => console.error("Erro ao carregar categorias:", err));

            const itemQuery = query(collection(state.db, 'menu_items'), orderBy('displayOrder'));
            state.listeners.items = onSnapshot(itemQuery, (snapshot) => {
                state.menu.items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.location.hash.startsWith('#admin') ? renderAdminPage() : updateMenuUI();
            }, (err) => console.error("Erro ao carregar itens:", err));
        };
        
        // --- MODAL SYSTEM ---
        const showModal = ({ title, body, confirmText = 'Confirmar', cancelText = 'Cancelar', onConfirm, showCancel = true }) => {
            const modalId = `modal-${Date.now()}`;
            modalsContainer.innerHTML = `<div class="modal-overlay open" id="${modalId}"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">${title}</h3><button class="modal-close-btn">&times;</button></div><div class="modal-body">${body}</div><div class="modal-footer">${showCancel ? `<button class="btn btn--secondary">${cancelText}</button>` : ''}<button class="btn btn--primary">${confirmText}</button></div></div></div>`;
            
            const overlay = document.getElementById(modalId);
            const closeModal = () => { overlay.classList.remove('open'); setTimeout(() => { if(overlay.parentElement) { modalsContainer.innerHTML = ''; } }, 200); };

            overlay.querySelector('.btn--primary').addEventListener('click', () => { if(onConfirm) onConfirm(); closeModal(); });
            overlay.addEventListener('click', e => { if (e.target === overlay || e.target.closest('.modal-close-btn') || (e.target.closest('.btn--secondary') && showCancel) ) { closeModal(); } });
        };
        
        const showFormModal = ({ title, body, submitText = 'Salvar', onSubmit }) => {
            const modalId = `modal-${Date.now()}`;
            const formId = `form-${modalId}`;
            modalsContainer.innerHTML = `<div class="modal-overlay open" id="${modalId}"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">${title}</h3><button class="modal-close-btn">&times;</button></div><form id="${formId}">${body}<div class="modal-footer"><button type="button" class="btn btn--secondary">Cancelar</button><button type="submit" class="btn btn--primary">${submitText}</button></div></form></div></div>`;
            
            const overlay = document.getElementById(modalId);
            const form = document.getElementById(formId);
            const closeModal = () => { overlay.classList.remove('open'); setTimeout(() => modalsContainer.innerHTML = '', 200); };

            form.addEventListener('submit', e => { e.preventDefault(); if(onSubmit) onSubmit(new FormData(form)); closeModal(); });
            overlay.addEventListener('click', e => { if (e.target === overlay || e.target.closest('.modal-close-btn') || e.target.closest('.btn--secondary')) { closeModal(); } });
        };

        // --- INITIALIZATION ---
        const init = () => {
            state.cart = loadCartFromStorage();
            onAuthStateChanged(state.auth, handleAuthChange);
            window.addEventListener('hashchange', handleRouting);
            handleRouting();
        };

        init();
    </script>
</body>
</html>

